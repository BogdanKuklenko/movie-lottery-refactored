# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Worker Timeout –ø—Ä–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏

**–î–∞—Ç–∞:** 1 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

---

## –ü—Ä–æ–±–ª–µ–º–∞

Worker'—ã –ø–∞–¥–∞–ª–∏ **–ù–ï –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å —Å–∞–π—Ç–æ–º**:
- –û—Ç–∫—Ä—ã—Ç–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí TIMEOUT
- –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ—Ç–µ—Ä–µ–∏ ‚Üí TIMEOUT  
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É ‚Üí TIMEOUT

```
[INFO] Booting worker with pid: 123
...–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–∞–π—Ç...
[CRITICAL] WORKER TIMEOUT (pid:123)
[ERROR] Worker was sent SIGKILL!
```

---

## –ü—Ä–∏—á–∏–Ω—ã

### 1. –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–æ–≤

–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
```python
get_background_photos() ‚Üí BackgroundPhoto.query...
```

–ï—Å–ª–∏ PostgreSQL –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ ‚Üí –∑–∞–≤–∏—Å–∞–Ω–∏–µ –Ω–∞ 30+ —Å–µ–∫—É–Ω–¥.

### 2. –¢–∞–±–ª–∏—Ü—ã –ë–î –Ω–µ —Å–æ–∑–¥–∞–Ω—ã

–ú—ã –æ—Ç–∫–ª—é—á–∏–ª–∏ `db.create_all()` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –ø–æ—ç—Ç–æ–º—É —Ç–∞–±–ª–∏—Ü—ã –º–æ–≥–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.

### 3. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ –ë–î –ø–∞–¥–∞–ª, –≤–µ—Å—å worker —É–º–∏—Ä–∞–ª.

---

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è PostgreSQL

**–§–∞–π–ª:** `movie_lottery/config.py`

```python
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_pre_ping': True,  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    'pool_recycle': 300,    # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω
    'connect_args': {
        'connect_timeout': 10,  # Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è 10 —Å–µ–∫
    }
}
```

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π `db.create_all()`

**–§–∞–π–ª:** `movie_lottery/__init__.py`

```python
try:
    with app.app_context():
        db.create_all()
except Exception as e:
    app.logger.warning(f"Could not create tables: {e}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É - —Ç–∞–±–ª–∏—Ü—ã –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ helpers

**–§–∞–π–ª:** `movie_lottery/utils/helpers.py`

```python
def get_background_photos():
    try:
        photos = BackgroundPhoto.query...
        return [...]
    except (ProgrammingError, Exception):
        return []  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –≤–º–µ—Å—Ç–æ –ø–∞–¥–µ–Ω–∏—è

def ensure_background_photo(poster_url):
    try:
        # ... —Ä–∞–±–æ—Ç–∞ —Å –ë–î ...
    except Exception:
        pass  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
```

---

## –ö–∞–∫ –¥–µ–ø–ª–æ–∏—Ç—å

### 1. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```bash
git add .
git commit -m "Critical fix: Add DB timeouts and error handling"
git push
```

### 2. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ Render.com (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–ª–∏):

**Start Command:**
```bash
gunicorn --config gunicorn_config.py "movie_lottery:create_app()"
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ Render.com:

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ `DATABASE_URL` (PostgreSQL):
```
DATABASE_URL=postgresql://...
```

–ï—Å–ª–∏ –Ω–µ—Ç - Render –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –µ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ PostgreSQL.

---

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

1. ‚úÖ Worker –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∑–∞ 2-3 —Å–µ–∫—É–Ω–¥—ã
2. ‚úÖ –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
3. ‚úÖ –ù–µ—Ç WORKER TIMEOUT
4. ‚úÖ –ù–µ—Ç SIGKILL
5. ‚úÖ –°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

**–õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:**
```
[INFO] Starting gunicorn 23.0.0
[INFO] Listening at: http://0.0.0.0:10000
[INFO] Booting worker with pid: 123
==> Your service is live üéâ

...–Ω–µ—Ç –±–æ–ª—å—à–µ –æ—à–∏–±–æ–∫...
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

### 1. –õ–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:

–î–æ–±–∞–≤—å—Ç–µ –≤ `__init__.py` –≤—Ä–µ–º–µ–Ω–Ω–æ:
```python
app.logger.info(f"DATABASE_URL configured: {bool(db_uri)}")
app.logger.info(f"Starting db.create_all()...")
db.create_all()
app.logger.info(f"db.create_all() completed!")
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ PostgreSQL –Ω–∞ Render:

- –ó–∞–π–¥–∏—Ç–µ –≤ Dashboard ‚Üí –í–∞—à—É –ë–î
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞ (–Ω–µ –≤ —Ä–µ–∂–∏–º–µ Suspended)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Connection String

### 3. –ï—Å–ª–∏ PostgreSQL –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

–°–æ–∑–¥–∞–π—Ç–µ PostgreSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ Render.com:
1. Dashboard ‚Üí New ‚Üí PostgreSQL
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ –≤–∞—à–µ–º—É Web Service
3. Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç DATABASE_URL

---

## –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

1. ‚úÖ `movie_lottery/config.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã PostgreSQL
2. ‚úÖ `movie_lottery/__init__.py` - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π db.create_all()
3. ‚úÖ `movie_lottery/utils/helpers.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î
4. ‚úÖ `gunicorn_config.py` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å timeout=120
5. ‚úÖ `movie_lottery/routes/api_routes.py` - —É–±—Ä–∞–Ω –∏–º–ø–æ—Ä—Ç magnet_search

---

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫:

```bash
git log --oneline  # –ù–∞–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
git revert <commit_hash>
git push
```

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–í–µ—Ä—Å–∏—è:** 3.0 (Final)  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–¢–∏–ø:** Database timeout fix + error handling

