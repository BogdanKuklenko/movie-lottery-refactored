# Изменение приоритетов балансировки торрентов

**Дата:** 1 октября 2025  
**Статус:** ✅ **РЕАЛИЗОВАНО**

---

## Что изменилось

Изменен порядок приоритетов при выборе торрентов для более интеллектуального отбора.

### Старая балансировка:
```
1. Русская озвучка: +100 баллов
2. Качество 1080p: +50 баллов
3. Количество сидов: log₁₀(seeds+1) × 10 (~20-30 баллов)
```

### Новая балансировка:
```
1. Русская озвучка: +200 баллов (ПРИОРИТЕТ №1!)
2. Количество сидов: log₁₀(seeds+1) × 30 (~60-90 баллов)
3. Качество 1080p: +20 баллов
```

---

## Обоснование изменений

### 1. Русская озвучка (+100 → +200)
- **Увеличен вес в 2 раза**
- Русская озвучка — самый важный критерий для пользователя
- Теперь торрент с озвучкой практически всегда будет выбран, даже если он имеет меньше сидов или худшее качество

### 2. Количество сидов (×10 → ×30)
- **Увеличено влияние в 3 раза**
- Количество сидов напрямую влияет на скорость загрузки
- Теперь торрент со 100 сидами получает ~60 баллов вместо ~20
- Это второй по важности фактор после озвучки

### 3. Качество 1080p (+50 → +20)
- **Уменьшено влияние в 2.5 раза**
- Качество важно, но не критично
- Лучше быстро скачать 720p с озвучкой, чем долго ждать 1080p без озвучки

---

## Примеры сравнения

### Пример 1: Торрент с озвучкой vs высокое качество

**До изменений:**
```
Торрент А: 200 сидов, 1080p, БЕЗ озвучки
  = 23 + 50 + 0 = 73 балла

Торрент Б: 10 сидов, 720p, С ОЗВУЧКОЙ
  = 10 + 0 + 100 = 110 баллов ← ВЫБРАН

Разница: 37 баллов (может быть выбран А при большой разнице в сидах)
```

**После изменений:**
```
Торрент А: 200 сидов, 1080p, БЕЗ озвучки
  = 0 + 69 + 20 = 89 баллов

Торрент Б: 10 сидов, 720p, С ОЗВУЧКОЙ
  = 200 + 31 + 0 = 231 баллов ← ВЫБРАН

Разница: 142 балла (Б всегда будет выбран!)
```

### Пример 2: Выбор между торрентами с озвучкой

**До изменений:**
```
Торрент А: 50 сидов, 1080p, озвучка
  = 17 + 50 + 100 = 167 баллов ← ВЫБРАН

Торрент Б: 100 сидов, 720p, озвучка
  = 20 + 0 + 100 = 120 баллов

Качество перевешивает сиды
```

**После изменений:**
```
Торрент А: 50 сидов, 1080p, озвучка
  = 200 + 51 + 20 = 271 баллов

Торрент Б: 100 сидов, 720p, озвучка
  = 200 + 60 + 0 = 260 баллов ← Почти равны!

Сиды теперь играют большую роль при равной озвучке
```

---

## Технические детали

### Измененные файлы:

1. **Код:**
   - `movie_lottery/utils/magnet_search.py` - функция `_calculate_torrent_score()`

2. **Документация:**
   - `NEW_TRACKERS_UPDATE.md`
   - `RUSSIAN_AUDIO_SEARCH_UPDATE.md`
   - `RUSSIAN_TRACKERS_ONLY.md`
   - `FINAL_RUSSIAN_TRACKERS_SUMMARY.txt`
   - `FINAL_RUSSIAN_AUDIO_SUMMARY.txt`

### Обновленная функция:

```python
def _calculate_torrent_score(torrent_data: Dict[str, Any], prefer_1080p: bool = True) -> float:
    """Вычисляет балл торрента на основе русской озвучки, количества сидов и качества.
    
    Приоритеты (от важного к менее важному):
    1. Русская озвучка - приоритет №1!
    2. Количество сидеров - приоритет №2
    3. Качество видео (1080p) - приоритет №3
    """
    score = 0.0
    name = str(torrent_data.get("name") or torrent_data.get("title") or "")
    
    # ПРИОРИТЕТ №1: Огромный бонус за русскую озвучку
    if _has_russian_audio(name):
        score += 200
    
    # ПРИОРИТЕТ №2: Увеличенный балл от сидов
    seeders = _extract_seeders(torrent_data)
    if seeders > 0:
        import math
        score += math.log10(seeders + 1) * 30
    
    # ПРИОРИТЕТ №3: Умеренный бонус за качество 1080p
    if prefer_1080p and ("1080p" in name.lower() or "1080" in name.lower()):
        score += 20
    
    return score
```

---

## Ожидаемые результаты

1. ✅ **Торренты с русской озвучкой будут выбираться практически всегда**
2. ✅ **При равной озвучке выбор будет основан на количестве сидов** (быстрая загрузка)
3. ✅ **Качество играет роль только при близких значениях других параметров**
4. ✅ **Общее улучшение пользовательского опыта** - фильмы с озвучкой скачиваются быстрее

---

## Обратная совместимость

- ✅ Изменения полностью обратно совместимы
- ✅ Не требуется изменений в базе данных
- ✅ API остается неизменным
- ✅ Существующие торренты продолжат работать

---

## Тестирование

Рекомендуется протестировать изменения на следующих сценариях:

1. Поиск популярного фильма (много торрентов с разными параметрами)
2. Поиск редкого фильма (мало торрентов)
3. Поиск русского фильма (должна быть озвучка)
4. Поиск нового фильма (может не быть озвучки)

---

**Автор:** AI Assistant  
**Версия:** 1.0

