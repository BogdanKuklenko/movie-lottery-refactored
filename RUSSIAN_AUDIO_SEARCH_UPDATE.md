# Обновление: Поиск торрентов с русской озвучкой

**Дата:** 1 октября 2025  
**Статус:** ✅ **РЕАЛИЗОВАНО**

---

## Проблема

Предыдущая версия поиска находила **только оригинальные версии фильмов** без русской озвучки. 
Для английских фильмов это означало, что пользователи получали торренты с английским аудио без перевода.

### Примеры проблем:
- ❌ "Inception 2010" → найдено с английской озвучкой
- ❌ "The Matrix 1999" → найдено с английской озвучкой  
- ❌ Нет фильтрации по наличию русского дубляжа
- ❌ Нет баланса между качеством и количеством сидов

---

## Решение

Реализована **умная система поиска с приоритетом на русскую озвучку** и балансировкой качества/сидов.

### 1. Определение русской озвучки

Добавлена функция `_has_russian_audio()`, которая определяет наличие русской озвучки по ключевым словам:

```python
russian_audio_keywords = [
    # Типы озвучки
    'дубляж', 'дублированный', 'многоголос', 'двухголос',
    'профессиональный', 'лицензия', 'лиц.', 
    'дубл.', 'dubl', 'rus', 'russian',
    'звук', 'озвуч', 'перевод',
    
    # Студии озвучки
    'baibako', 'lostfilm', 'newstudio', 'alexfilm',
    'paramount comedy', 'кураж-бамбей', 'amedia'
]
```

### 2. Балльная система оценки торрентов

Функция `_calculate_torrent_score()` вычисляет балл для каждого торрента:

```
БАЛЛ = LOG10(сиды + 1) × 10 + Бонус_за_1080p + Бонус_за_русскую_озвучку

Бонусы:
- Русская озвучка: +100 баллов (ПРИОРИТЕТ №1!)
- Качество 1080p:  +50 баллов
- Сиды: до ~30 баллов (логарифмическая шкала)
```

**Пример расчета:**

```
Торрент А: "Inception 2010 1080p BluRay"
  - Сиды: 50 → LOG10(51) × 10 = ~17 баллов
  - 1080p: +50 баллов
  - Русской озвучки нет: 0 баллов
  ИТОГО: ~67 баллов

Торрент Б: "Inception 2010 720p [Дубляж]"
  - Сиды: 10 → LOG10(11) × 10 = ~10 баллов
  - 1080p: 0 баллов
  - Русская озвучка: +100 баллов
  ИТОГО: ~110 баллов

ВЫБРАН ТОРРЕНТ Б! ✓
```

### 3. Умные варианты поиска

#### Для английских фильмов:
```python
query = "Inception 2010"

Варианты запросов (в порядке приоритета):
1. "Inception 2010 дубляж 1080p"  # Лучший вариант
2. "Inception 2010 многоголосый"  # Альтернатива
3. "Inception 2010 russian"       # Английский + russian
4. "Inception 2010 rus"           # Короткая форма
5. "Inception 2010"               # Fallback
```

#### Для русских фильмов:
```python
query = "Брат 1997"

Варианты запросов:
1. "Брат 1997 дубляж"
2. "Брат 1997 многоголосый"
3. "Брат 1997"
4. "Brat 1997 russian"  # Транслитерация
5. "Brat 1997"
```

---

## Новые функции

### `_has_russian_audio(torrent_name: str) -> bool`
Проверяет, содержит ли название торрента указание на русскую озвучку.

**Использование:**
```python
_has_russian_audio("Inception 2010 1080p Дубляж")  # True
_has_russian_audio("Inception 2010 1080p YIFY")    # False
_has_russian_audio("Movie [LostFilm]")             # True
_has_russian_audio("Film многоголосый перевод")    # True
```

### `_calculate_torrent_score(torrent_data: Dict, prefer_1080p: bool = True) -> float`
Вычисляет балл торрента на основе качества, сидов и наличия русской озвучки.

**Использование:**
```python
torrent = {
    "name": "Inception 2010 1080p [Дубляж]",
    "seeders": 50
}
score = _calculate_torrent_score(torrent)
# score = ~167 (сиды: 17 + 1080p: 50 + русская озвучка: 100)
```

### `_search_via_piratebay()` - обновлена
Теперь сортирует результаты по балльной системе и логирует топ-3 результата.

**Новое поведение:**
```
INFO - Trying PirateBay (RUS priority)...
DEBUG -   #1 (score=167.0, rus=True, seeds=50): Inception 2010 1080p [Дубляж]
DEBUG -   #2 (score=70.0, rus=False, seeds=100): Inception 2010 1080p YIFY
DEBUG -   #3 (score=45.0, rus=False, seeds=20): Inception 2010 720p
INFO - Selected torrent (Russian audio: True): Inception 2010 1080p [Дубляж]
```

### `search_best_magnet()` - обновлена
Автоматически добавляет ключевые слова для поиска русской озвучки.

---

## Как это работает

### Сценарий 1: Английский фильм

```
Запрос: "The Matrix 1999"

Шаг 1: Генерация вариантов запроса
  ✓ "The Matrix 1999 дубляж 1080p"
  ✓ "The Matrix 1999 многоголосый"
  ✓ "The Matrix 1999 russian"
  ✓ "The Matrix 1999 rus"
  ✓ "The Matrix 1999"

Шаг 2: Поиск первого варианта
  → Найдено 15 торрентов
  
Шаг 3: Расчет баллов
  #1 (score=155): The Matrix 1999 1080p Дубляж [50 сидов]
  #2 (score=90): The Matrix 1999 1080p YIFY [200 сидов]
  #3 (score=70): The Matrix 1999 720p [100 сидов]

Шаг 4: Выбор победителя
  ✓ Выбран #1 - с русской озвучкой!
```

### Сценарий 2: Русский фильм

```
Запрос: "Брат 1997"

Шаг 1: Генерация вариантов
  ✓ "Брат 1997 дубляж"
  ✓ "Брат 1997 многоголосый"
  ✓ "Брат 1997"
  ✓ "Brat 1997 russian" (транслитерация)
  ✓ "Brat 1997"

Шаг 2: Поиск → Найдено!
  ✓ Выбран торрент с лучшим балансом качества и сидов
```

---

## Преимущества новой системы

### 1. Приоритет русской озвучке ✓
```
Торрент с русской озвучкой + 720p + 5 сидов
  ЛУЧШЕ чем
Торрент без озвучки + 1080p + 100 сидов
```

### 2. Умная балансировка ✓
- Не просто "максимум сидов"
- Не просто "только 1080p"
- **Баланс между качеством, сидами и озвучкой**

### 3. Множественные варианты поиска ✓
- Автоматическое добавление ключевых слов
- До 5 вариантов запроса для каждого фильма
- Увеличенный шанс найти нужный торрент

### 4. Детальное логирование ✓
```
INFO - [1/5] Searching with: 'Inception 2010 дубляж 1080p'
INFO -   → Trying PirateBay (RUS priority)...
DEBUG -   #1 (score=167.0, rus=True, seeds=50): Inception...
DEBUG -   #2 (score=70.0, rus=False, seeds=100): Inception...
INFO - Selected torrent (Russian audio: True): Inception...
```

### 5. Гибкая настройка ✓
Легко добавить новые:
- Ключевые слова озвучки
- Студии дубляжа
- Варианты запросов

---

## Распознаваемые типы озвучки

### Типы перевода
- ✓ Дубляж / Дублированный
- ✓ Многоголосый / Двухголосый
- ✓ Профессиональный перевод
- ✓ Лицензия

### Студии озвучки
- ✓ Baibako
- ✓ LostFilm
- ✓ NewStudio
- ✓ AlexFilm
- ✓ Paramount Comedy
- ✓ Кураж-Бамбей
- ✓ Amedia

### Метки
- ✓ RUS / Russian
- ✓ Дубл. / Dubl
- ✓ Лиц.
- ✓ Озвучка / Звук

---

## Примеры названий торрентов

### Распознаются как русская озвучка:
```
✓ "Inception 2010 1080p BluRay [Дубляж]"
✓ "The Matrix 1999 BDRip 1080p Rus"
✓ "Interstellar 2014 (Многоголосый перевод)"
✓ "Film 2020 1080p [LostFilm]"
✓ "Movie HDRip Лицензия"
✓ "Series S01 Профессиональный двухголосый"
```

### НЕ распознаются (оригинал):
```
✗ "Inception 2010 1080p BluRay YIFY"
✗ "The Matrix 1999 BDRip x264"
✗ "Interstellar 2014 4K UHD"
```

---

## Совместимость

✅ Полностью обратно совместима  
✅ Не требует изменений в других частях приложения  
✅ Работает с существующей базой данных  
✅ API эндпоинты не изменились  

---

## Производительность

- ⚡ Быстрая оценка торрентов (O(n) где n - количество результатов)
- ⚡ Логарифмическая шкала для сидов предотвращает переоценку популярных торрентов
- ⚡ Кэширование результатов в базе данных

---

## Файлы изменений

- ✏️ `movie_lottery/utils/magnet_search.py` - основная логика
- 📄 `RUSSIAN_AUDIO_SEARCH_UPDATE.md` - эта документация

---

## Будущие улучшения

### Возможные направления:

1. **Добавление больше студий озвучки**
   - Пополнение списка известных студий
   - Автоматическое обучение на основе пользовательских предпочтений

2. **Настраиваемые приоритеты**
   - Пользовательские предпочтения (озвучка vs качество)
   - Минимальное количество сидов

3. **Интеграция с RuTracker**
   - Лучший источник для русской озвучки
   - Требует авторизацию

4. **Фильтрация по типу озвучки**
   - Только дубляж
   - Только многоголосый
   - Любой русский перевод

---

**Статус:** ✅ Готово к использованию  
**Приоритет:** Русская озвучка > Качество 1080p > Количество сидов

