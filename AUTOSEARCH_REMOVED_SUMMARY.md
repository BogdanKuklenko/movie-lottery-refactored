# Отключение автопоиска магнет-ссылок

**Дата:** 1 октября 2025  
**Статус:** ✅ **ВЫПОЛНЕНО**

---

## Что было изменено

Полностью отключен автоматический поиск магнет-ссылок через торрент-трекеры. Теперь пользователь вручную ищет торренты на RuTracker и вставляет магнет-ссылки.

---

## Изменения в UI (Frontend)

### 1. Шаблоны HTML

**Файлы:**
- `movie_lottery/templates/library.html`
- `movie_lottery/templates/history.html`

**Изменение:**
```diff
- <button class="icon-button search-button" title="Искать торрент">
+ <button class="icon-button add-magnet-button" title="Добавить magnet-ссылку">
```

Кнопка "Искать торрент" → "Добавить magnet-ссылку"

### 2. JavaScript обработчики

**Файлы:**
- `movie_lottery/static/js/pages/library.js`
- `movie_lottery/static/js/pages/history.js`

**Что удалено:**
- ❌ Функция `triggerMagnetSearch()` - запуск автопоиска
- ❌ Функция `pollSearchStatus()` - опрос статуса поиска
- ❌ Функция `handleSearchStatus()` - обработка результатов
- ❌ Функция `setCardSearching()` - UI состояние поиска
- ❌ Функция `stopPolling()` - остановка опроса
- ❌ `activeSearchTimers` - таймеры для polling
- ❌ `beforeunload` обработчик - очистка таймеров

**Что добавлено:**
```javascript
// Кнопка теперь просто открывает модальное окно
} else if (button.classList.contains('add-magnet-button')) {
    // Открываем модальное окно для ручного ввода magnet-ссылки
    handleOpenModal(card);
}
```

### 3. Модальное окно (осталось без изменений)

**Файл:** `movie_lottery/static/js/components/modal.js`

✅ **Кнопка RuTracker сохранена** - открывает поиск на RuTracker.org
✅ **Поле ввода магнет-ссылки** - пользователь вставляет ссылку вручную
✅ **Кнопка "Сохранить"** - сохраняет введенную ссылку

---

## Изменения в Backend

### 1. Отключены автоматические вызовы поиска

**Файл:** `movie_lottery/routes/api_routes.py`

#### В эндпоинте `/api/lottery` (создание лотереи):
```python
# АВТОПОИСК ОТКЛЮЧЕН - пользователь вводит магнет-ссылки вручную
# for candidate in search_candidates:
#     if candidate['query']:
#         start_background_search(candidate['kinopoisk_id'], candidate['query'])
```

#### В эндпоинте `/api/library` (добавление в библиотеку):
```python
# АВТОПОИСК ОТКЛЮЧЕН - пользователь вводит магнет-ссылки вручную
# if target_kinopoisk_id:
#     query = _compose_search_query(...)
#     if query:
#         start_background_search(target_kinopoisk_id, query)
```

#### В эндпоинте `/api/search-magnet/<kinopoisk_id>` (ручной поиск):
```python
@api_bp.route('/search-magnet/<int:kinopoisk_id>', methods=['GET', 'POST'])
def search_magnet(kinopoisk_id):
    # АВТОПОИСК ОТКЛЮЧЕН - возвращаем сообщение об отключенной функции
    return jsonify({
        "status": "disabled",
        "kinopoisk_id": kinopoisk_id,
        "has_magnet": False,
        "magnet_link": "",
        "message": "Автопоиск магнет-ссылок отключен. Используйте кнопку RuTracker для поиска и вставьте ссылку вручную.",
    }), 200
```

### 2. Функции поиска сохранены (для возможного восстановления)

**Файл:** `movie_lottery/utils/magnet_search.py`

✅ Функция `search_best_magnet()` **сохранена**, но не используется
✅ Функция `start_background_search()` **сохранена**, но не вызывается
✅ Все парсеры трекеров **сохранены** (RuTor, RuTracker, и т.д.)

---

## Что осталось работать

### ✅ Ручное сохранение магнет-ссылок
**Эндпоинт:** `/api/movie-magnet` (POST)
- Пользователь вводит магнет-ссылку в модальном окне
- Ссылка сохраняется в базе данных
- Кнопка меняется с "Добавить magnet" на "Скачать"

### ✅ Кнопка RuTracker в модальном окне
- Открывает поиск на RuTracker.org в новой вкладке
- Пользователь ищет нужный торрент
- Копирует магнет-ссылку
- Вставляет в поле ввода

### ✅ Скачивание торрентов
**Эндпоинт:** `/api/start-download/<kinopoisk_id>` (POST)
- После сохранения магнет-ссылки можно запустить загрузку
- Торрент добавляется в qBittorrent

### ✅ Удаление магнет-ссылок
**Эндпоинт:** `/api/movie-magnet` (DELETE)
- Кнопка "Удалить" в модальном окне

---

## Новый рабочий процесс

### Сценарий использования:

1. **Пользователь добавляет фильм в библиотеку или создает лотерею**
   - Фильм появляется в галерее с кнопкой "Добавить magnet"

2. **Пользователь нажимает кнопку "Добавить magnet"**
   - Открывается модальное окно с информацией о фильме
   - Видно поле ввода для магнет-ссылки
   - Видна кнопка "RuTracker"

3. **Пользователь нажимает кнопку "RuTracker"**
   - Открывается новая вкладка с поиском на RuTracker.org
   - Пользователь ищет нужный торрент
   - Выбирает подходящий (с русской озвучкой, хорошим качеством, достаточным количеством сидов)

4. **Пользователь копирует магнет-ссылку**
   - На RuTracker находит кнопку "Скачать" или магнет-ссылку
   - Копирует ссылку формата `magnet:?xt=urn:btih:...`

5. **Пользователь вставляет ссылку в приложение**
   - Возвращается на вкладку с приложением
   - Вставляет ссылку в поле ввода
   - Нажимает "Сохранить"

6. **Ссылка сохранена**
   - Кнопка на карточке меняется на "Скачать"
   - Можно запустить загрузку в qBittorrent

---

## Преимущества нового подхода

### ✅ Полный контроль пользователя
- Пользователь сам выбирает торрент
- Можно посмотреть описание, комментарии, рейтинг
- Можно выбрать конкретную раздачу с нужной озвучкой

### ✅ Надежность
- Не зависит от работы автоматических парсеров
- Не блокируется антибот-защитой трекеров
- RuTracker всегда доступен для ручного поиска

### ✅ Гибкость
- Можно искать на любом трекере, не только RuTracker
- Можно использовать магнет-ссылки из любого источника
- Можно выбирать по дополнительным критериям (субтитры, качество звука, и т.д.)

### ✅ Простота кода
- Удалено ~200 строк кода polling логики
- Нет фоновых задач
- Нет таймеров и их очистки
- Нет обработки статусов поиска

---

## Недостатки (и почему это приемлемо)

### ⚠️ Требуется ручная работа
- Пользователь должен сам искать торренты
- **Но:** Это дает больше контроля и надежности

### ⚠️ Дольше добавить фильм
- Нужно открыть RuTracker, найти, скопировать
- **Но:** Это всего 30-60 секунд на фильм

### ⚠️ Требует доступа к RuTracker
- RuTracker может быть заблокирован провайдером
- **Но:** Пользователь может использовать VPN или зеркала

---

## Возможность восстановления автопоиска

Если потребуется восстановить автопоиск:

1. **Раскомментировать код в `api_routes.py`:**
   - Строки 156-158 (лотерея)
   - Строки 272-280 (библиотека)
   - Строки 337-364 (эндпоинт search-magnet)

2. **Раскомментировать обработчики в JS:**
   - Восстановить функции в `library.js`
   - Восстановить функции в `history.js`

3. **Вернуть кнопку "search-button" в шаблонах:**
   - Заменить `add-magnet-button` → `search-button`

Все функции поиска (`search_best_magnet`, парсеры трекеров) сохранены в `magnet_search.py` и готовы к использованию.

---

## Файлы, которые были изменены

### Frontend:
1. ✅ `movie_lottery/templates/library.html` - изменена кнопка
2. ✅ `movie_lottery/templates/history.html` - изменена кнопка
3. ✅ `movie_lottery/static/js/pages/library.js` - удалены функции автопоиска
4. ✅ `movie_lottery/static/js/pages/history.js` - удалены функции автопоиска

### Backend:
5. ✅ `movie_lottery/routes/api_routes.py` - отключены вызовы автопоиска

### Без изменений:
- ✅ `movie_lottery/static/js/components/modal.js` - кнопка RuTracker сохранена
- ✅ `movie_lottery/utils/magnet_search.py` - функции сохранены для возможного восстановления
- ✅ База данных - структура не изменена

---

## Тестирование

Рекомендуется протестировать:

1. ✅ Добавление фильма в библиотеку
2. ✅ Нажатие кнопки "Добавить magnet"
3. ✅ Открытие модального окна
4. ✅ Кнопка "RuTracker" открывает поиск
5. ✅ Ввод и сохранение магнет-ссылки
6. ✅ Кнопка меняется на "Скачать"
7. ✅ Запуск загрузки торрента

---

**Автор:** AI Assistant  
**Версия:** 1.0  
**Изменений:** Отключен автопоиск, оставлен ручной ввод магнет-ссылок

